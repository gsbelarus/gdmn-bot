%YAML 1.1
--- 
StructureVersion: "1.0"
Properties: 
  RUID: 158513268_1444931844
  Name: "ZarobakBot.Сбор данных"
  Caption: "ZarobakBot.Сбор данных"
  Version: "1.0.0.28"
  Optional: False
  Internal: True
  MD5: 0ADA8EE84AC7A20891E0E18801B067F3
Objects: 
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147160790_1454092899
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "bot_strRepl"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2020-05-13T12:32:18+03:00
      DISPLAYSCRIPT: | 
        BOT_STRREPL
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QDAAAAU1RSAwAAAFNUUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNURkxQUg==
      SCRIPT: | 
        Option Explicit
        
        '  Функция заменяет символы обратного слэша, двойной кавычки
        '  и перевода строки на управляющие команды.
        '
        '  Необходима для записи строки в JSON.
        
        Function bot_strRepl(str)
          bot_strRepl = Trim(Replace(Replace(Replace(Replace(Replace(str, "\", "\\"), """", "\"""), vbCrLf, "\n"), vbTab, "\t"), vbCr, "\n"))
        
        End Function
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 1193785764_1320926323
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "bot_PreparePaySlip"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2020-06-23T14:16:55+03:00
      DISPLAYSCRIPT: | 
        BOT_PREPAREPAYSLIP
        BOT_PREPAREPAYSLIP_ROLLBACK
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAUEVSSU9EBgAAAFBFUklPRAAAAAAAAAAAAAAAAAwAAAAAAAAAAAAAAABGTlNU
        UFJTVAoAAABDVVNUT01FUklECgAAAENVU1RPTUVSSUQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        Rk5TVFBSU1QJAAAAQ09NUEFOWUlECQAAAENPTVBBTllJRAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        AABGTlNUUFJTVAkAAABJU1JFV1JJVEUJAAAASVNSRVdSSVRFAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAEZOU1RQUlNUCAAAAElTTUFOVUFMCAAAAElTTUFOVUFMAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAEZOU1RQUlNUBQAAAEpTT05TBQAAAEpTT05TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      SCRIPT: | 
        Option Explicit
        Function bot_PreparePaySlip(Period, customerId, companyId, isRewrite, isManual, ByRef Jsons)
          dim qSel, Creator, Transaction
          set Creator = new TCreator
          set Transaction = Creator.GetObject(nil, "TIBTransaction", "")
          Transaction.Defaultdatabase = IBLogin.Database
          if not Transaction.InTransaction then
            Transaction.StartTransaction
          end if
        
          except bot_PreparePaySlipByEmploee_RollBack(Transaction)
        
          'pDate - дата окончания последнего итогового
          dim qSelDate, pDate
          set qSelDate = Creator.GetObject(nil, "TIBSQL", "")
          qSelDate.Transaction = gdcBaseManager.ReadTransaction
          qSelDate.SQL.Text = _
            "  SELECT FIRST 1 t.USR$DATEEND " & _
            "  FROM USR$WG_TOTAL t " & _
            "    JOIN USR$WG_TOTALLINE tline ON tline.MASTERKEY = t.DOCUMENTKEY " & _
            "    LEFT JOIN GD_DOCUMENT doc ON doc.ID = t.DOCUMENTKEY " & _
            "  WHERE doc.COMPANYKEY = :companyId " & _
            "  ORDER BY t.USR$DATEEND DESC "
          qSelDate.ParamByName("companyId").AsInteger = companyId
          qSelDate.ExecQuery
          pDate = qSelDate.FieldByName("USR$DATEEND").AsDateTime
        
          if isManual then
            dim qSelCount
            set qSelCount = Creator.GetObject(nil, "TIBSQL", "")
            qSelCount.Transaction = gdcBaseManager.ReadTransaction
            qSelCount.SQL.Text = _
              "  SELECT COUNT(DISTINCT p.CONTACTKEY) AS C " & _
              "  FROM USR$WG_TOTAL t " & _
              "    LEFT JOIN USR$WG_TOTALLINE tline ON tline.MASTERKEY = t.DOCUMENTKEY " & _
              "    LEFT JOIN USR$WG_P_EMPLMOVESTATE(tline.USR$EMPLKEY, t.USR$DATEEND) state ON 1 = 1 " & _
              "    LEFT JOIN USR$WG_MOVEMENTLINE ml ON ml.DOCUMENTKEY = state.ID " & _
              "    LEFT JOIN GD_PEOPLE p ON p.CONTACTKEY = tline.USR$EMPLKEY " & _
              "    LEFT JOIN GD_DOCUMENT doc ON doc.ID = t.DOCUMENTKEY " & _
              "    JOIN USR$WG_EMPLWORKTERM w ON w.USR$FIRSTMOVEKEY = ml.USR$FIRSTMOVE " & _
              "    LEFT JOIN USR$WG_P_EMPLCARDSTATE(tline.USR$EMPLKEY, :pDate) pcard ON 1 = 1 " & _
              "    LEFT JOIN USR$WG_PERSONALCARD card ON card.ID = pcard.ID " & _
              "  WHERE COALESCE(TRIM(card.USR$PERSONALNUMBER), '') <> '' AND " & _
              "    t.USR$DATEBEGIN >= :DB AND t.USR$DATEEND <= :DE " & _
              "    AND doc.COMPANYKEY = :companyId " & _
              "    AND (w.USR$DATEEND > :pDate OR w.USR$DATEEND IS NULL) " & _
              "    AND (ml.USR$MOVEMENTTYPE <> 3 OR tline.USR$CREDIT <> 0 OR tline.USR$DEBIT <> 0)  "
            qSelCount.ParamByName("DB").AsDateTime = Period(0)
            qSelCount.ParamByName("DE").AsDateTime = Period(1)
            qSelCount.ParamByName("companyId").AsInteger = companyId
            qSelCount.ParamByName("pDate").AsDateTime = pDate
            qSelCount.ExecQuery
        
            dim count
            count = qSelCount.FieldByName("C").AsInteger
        
            dim P : set P = Creator.GetObject(nil, "TgdccProgress", "")
            P.StartWork "ZarobakBot", "Формируем данные..", count, True, True
          end if
        
          Dim b
          If isRewrite Then b = "true" Else b = "false"
        
          'Формируем расчетные листки за период,
          'но сотрудников берем тех, кто работает на дату окончания последнего итогового начисления - pDate
          set qSel = Creator.GetObject(nil, "TIBSQL", "")
          qSel.Transaction = Transaction
          qSel.SQL.Text = _
            "EXECUTE BLOCK (DB DATE = :DB, DE DATE = :DE, PDATE DATE = :PDATE, COMPANYID dintkey = :COMPANYID) " & _
            "RETURNS ( " & _
            "  EmployeeKey     dforeignkey,      " & _
            "  EmployeeRuid    VARCHAR(40), " & _
            "  NickName        VARCHAR(160), " & _
            "  accdedStr       VARCHAR(10000) " & _
            "  ) " & _
            "AS " & _
            "  DECLARE TotalDocKey         dintkey; " & _
            "  DECLARE CurMonth            INTEGER; " & _
            "  DECLARE CurYear             INTEGER; " & _
            "  DECLARE IncDate             DATE; " & _
            "  DECLARE DetStr              VARCHAR(240); " & _
            "  DECLARE IncMonth            INTEGER; " & _
            "  DECLARE IncYear             INTEGER; " & _
            "  DECLARE How                 DECIMAL(15,2); " & _
            "  DECLARE Dow                 DECIMAL(15,2); " & _
            "  DECLARE FeeTypeName         VARCHAR(90); " & _
            "  DECLARE typeId              VARCHAR(22); " & _
            "  DECLARE Category            VARCHAR(60); " & _
            "  DECLARE S                   DECIMAL(15,4); " & _
            "  DECLARE OnDateBegin         DATE; " & _
            "  DECLARE OnDateEnd           DATE; " & _
            "  DECLARE EndSaldo            DECIMAL(15,4); " & _
            "  DECLARE code                VARCHAR(8); " & _
            "  DECLARE DBJson              VARCHAR(20); " & _
            "  DECLARE DEJson              VARCHAR(20); " & _
            "BEGIN " & _
            "  FOR " & _
            "    SELECT " & _
            "      p.NICKNAME                  AS NickName, " & _
            "      CAST(r.XID AS VARCHAR(14)) || '_' || CAST(r.DBID AS VARCHAR(14)) AS EmployeeRuid, " & _
            "      tline.USR$EMPLKEY          AS EmployeeKey, " & _
            "      t.DOCUMENTKEY               AS TotalDocKey, " & _
            "      t.USR$DATEBEGIN             AS OnDateBegin, " & _
            "      t.USR$DATEEND               AS OnDateEnd, " & _
            "      SUM(tline.USR$ENDSALDO) " & _
            "    FROM USR$WG_TOTAL t " & _
            "      LEFT JOIN GD_DOCUMENT doc ON doc.ID = t.DOCUMENTKEY " & _
            "      LEFT JOIN USR$WG_TOTALLINE tline ON tline.MASTERKEY = t.DOCUMENTKEY " & _
            "      LEFT JOIN USR$WG_P_EMPLMOVESTATE(tline.USR$EMPLKEY, t.USR$DATEEND) state ON 1 = 1 " & _
            "      LEFT JOIN USR$WG_MOVEMENTLINE ml ON ml.DOCUMENTKEY = state.ID " & _
            "      LEFT JOIN GD_CONTACT dep ON dep.ID = ml.USR$DEPTKEY " & _
            "      LEFT JOIN WG_POSITION pos ON pos.ID = ml.USR$POSITIONKEY " & _
            "      LEFT JOIN GD_PEOPLE p ON p.CONTACTKEY = tline.USR$EMPLKEY " & _
            "      JOIN usr$wg_emplworkterm workterm ON workterm.USR$FIRSTMOVEKEY = ml.USR$FIRSTMOVE " & _
            "      LEFT JOIN USR$WG_P_EMPLCARDSTATE(tline.USR$EMPLKEY, :pDate) pcard ON 1 = 1 " & _
            "      LEFT JOIN USR$WG_PERSONALCARD card ON card.ID = pcard.ID " & _
            "      LEFT JOIN GD_P_GETRUID(p.CONTACTKEY) r ON 1 = 1 " & _
            "    WHERE COALESCE(card.USR$PERSONALNUMBER, '') <> '' AND " & _
            "      t.USR$DATEBEGIN >= :DB AND t.USR$DATEEND <= :DE " & _
            "      AND (ml.USR$MOVEMENTTYPE <> 3 OR tline.USR$CREDIT <> 0 OR tline.USR$DEBIT <> 0) " & _
            "      AND doc.COMPANYKEY = :companyId " & _
            "      AND (workterm.USR$DATEEND > :pDate OR workterm.USR$DATEEND IS NULL) " & _
            "    GROUP BY 1,2,3,4,5,6 " & _
            "    ORDER BY NickName, EmployeeRuid, t.USR$DATEBEGIN " & _
            "    INTO :NickName, :EmployeeRuid, :EmployeeKey, :TotalDocKey,  :OnDateBegin, :OnDateEnd, :EndSaldo " & _
            "    DO " & _
            "    BEGIN " & _
            "      CurMonth = EXTRACT(MONTH FROM OnDateBegin); " & _
            "      CurYear = EXTRACT(YEAR FROM OnDateBegin); " & _
            "      accdedStr = ''; " & _
            "      DBJson = EXTRACT(YEAR FROM OnDateBegin) || '.' || RIGHT('0' || EXTRACT(MONTH FROM OnDateBegin), 2) || '.' || RIGHT('0' || EXTRACT(DAY FROM OnDateBegin), 2); " & _
            "      DEJson = EXTRACT(YEAR FROM OnDateEnd) || '.' || RIGHT('0' || EXTRACT(MONTH FROM OnDateEnd), 2) || '.' || RIGHT('0' || EXTRACT(DAY FROM OnDateEnd), 2); " & _
            "      FOR " & _
            "        SELECT ft.USR$NUMERICCODE, " & _
            "          ft.USR$NAME                          AS Name, " & _
            "          CAST(r.XID AS VARCHAR(14)) || '_' || CAST(r.DBID AS VARCHAR(14)) AS typeId, " & _
            "          it.USR$DATEBEGIN                     AS IncDate, " & _
            "          EXTRACT(MONTH FROM it.USR$DATEBEGIN) AS IncMonth, " & _
            "          EXTRACT(YEAR FROM  it.USR$DATEBEGIN) AS IncYear, " & _
            "          CASE " & _
            "            WHEN ft.ID = <RUID XID = 147653395 DBID = 119619099/> THEN 'PENSION_TAX' " & _
            "            WHEN ft.ID = <RUID XID = 147567139 DBID = 119619099/> THEN 'INCOME_TAX' " & _
            "            WHEN ft.ID = <RUID XID = 147653396 DBID = 119619099/> THEN 'TRADE_UNION_TAX'  /*налог*/ " & _
            "            WHEN NOT gr_adv.FEETYPE IS NULL THEN 'ADVANCE'                    /*аванс*/ " & _
            "            WHEN COALESCE(ft.USR$DEDUCTION, 0) = 1 THEN 'DEDUCTION'           /*удержание*/ " & _
            "            ELSE 'ACCRUAL'                                                    /*начисление*/ " & _
            "          END  AS Category, " & _
            "          SUM( IIF(ft.ID IN (<RUID XID = 147653395 DBID = 119619099/>, " & _
            "                             <RUID XID = 147567139 DBID = 119619099/>, " & _
            "                             <RUID XID = 147653396 DBID = 119619099/>) " & _
            "                             OR NOT gr_adv.FEETYPE IS NULL " & _
            "                             OR COALESCE(ft.USR$DEDUCTION, 0) = 1, " & _
            "                             cr.USR$CREDIT, cr.USR$DEBIT  ) ) AS S, " & _
            "          SUM(cr.USR$HOW)                      AS How, " & _
            "          SUM(cr.USR$DOW)                      AS Dow " & _
            "        FROM USR$WG_TBLCHARGE cr " & _
            "        LEFT JOIN USR$WG_TOTAL it ON it.DOCUMENTKEY = cr.USR$INCDOCKEY " & _
            "        LEFT JOIN USR$WG_FEETYPE ft ON ft.ID = cr.USR$FEETYPEKEY " & _
            "        LEFT JOIN USR$WG_P_GETFEETYPEBYGROUP(<RUID XID = 184134911 DBID = 1194748640/>) gr_adv ON gr_adv.FEETYPE = ft.ID " & _
            "        LEFT JOIN GD_P_GETRUID(ft.ID) r ON 1 = 1 " & _
            "        WHERE cr.USR$TOTALDOCKEY = :TotalDocKey " & _
            "          AND cr.USR$EMPLKEY = :EmployeeKey " & _
            "          AND ft.ID <> <RUID XID = 147582378 DBID = 119619099/> /*выдача заплаты*/ " & _
            "          AND (cr.USR$CREDIT <> 0 OR cr.USR$DEBIT <> 0) " & _
            "        GROUP BY 1, 2, 3, 4, 5, 6, 7 " & _
            "        ORDER BY ft.USR$NUMERICCODE " & _
            "        INTO :code, :FeeTypeName, :typeId, " & _
            "             :IncDate, :IncMonth, :IncYear, :Category, " & _
            "             :S, :How, :Dow " & _
            "      DO " & _
            "        BEGIN " & _
            "          IF (How IS NULL) THEN How = 0; " & _
            "          IF (Dow IS NULL) THEN Dow = 0; " & _
            "          detStr = ''; " & _
            "          IF  (IncMonth <> CurMonth OR IncYear <> CurYear OR How > 0 OR Dow > 0 ) THEN " & _
            "          BEGIN " & _
            "            IF (Dow > 0) THEN " & _
            "            BEGIN " & _
            "              detStr = detStr || '""days"":' || Dow; " & _
            "            END " & _
            "            IF (How > 0) THEN " & _
            "            BEGIN " & _
            "              IF (detStr <> '') THEN " & _
            "                BEGIN " & _
            "                  detStr = detStr || ','; " & _
            "                END " & _
            "              detStr = detStr || '""hours"":' || How; " & _
            "            END " & _
            "            IF  (IncMonth <> CurMonth OR IncYear <> CurYear) THEN " & _
            "            BEGIN " & _
            "              IF (detStr <> '') THEN " & _
            "                BEGIN " & _
            "                  detStr = detStr || ','; " & _
            "                END " & _
            "              detStr = detStr || '""incMonth"":' || IncMonth || ','; " & _
            "              detStr = detStr || '""incYear"":' || IncYear; " & _
            "            END " & _
            "            ELSE " & _
            "              BEGIN " & _
            "              IncMonth = 0; " & _
            "              IncYear = 0; " & _
            "              END " & _
            "            detStr = '""det"": {' || detStr || '}'; " & _
            "          END " & _
            "          ELSE " & _
            "            BEGIN " & _
            "              IncMonth = 0; " & _
            "              IncYear = 0; " & _
            "            END " & _
            "          IF (accdedStr <> '') THEN accdedStr = accdedStr || ','; " & _
            "          accdedStr = accdedStr || '{""typeId"":""' || typeId || '"",""db"":""' || DBJson || " & _
            "            '"",""de"":""' || DEJson || " & _
            "            '"",""s"":' || S; " & _
            "          IF (detStr <> '') THEN accdedStr = accdedStr || ',' || detStr; " & _
            "          accdedStr = accdedStr || '}'; " & _
            "        END " & _
            "      FeeTypeName = ''; " & _
            "      S = 0; " & _
            "      IncMonth = 0; " & _
            "      IncYear = 0; " & _
            "      How = 0; " & _
            "      Dow = 0; " & _
            " " & _
            "      /*льготы*/ " & _
            "      FOR " & _
            "        SELECT pt.USR$CODE, " & _
            "          pt.USR$NAME        AS Name, " & _
            "          CAST(r.XID AS VARCHAR(14)) || '_' || CAST(r.DBID AS VARCHAR(14)) AS typeId, " & _
            "          'PRIVILAGE'        AS Category, " & _
            "          SUM(cha.USR$SUMMA) AS Summa " & _
            "        FROM USR$WG_CHREGADDINFO cha " & _
            "         JOIN USR$WG_PRIVILEGETYPE pt ON pt.ID = cha.USR$PRIVTYPEKEY " & _
            "         LEFT JOIN GD_P_GETRUID(pt.ID) r ON 1 = 1 " & _
            "        WHERE cha.USR$EMPLKEY = :EmployeeKey " & _
            "          AND cha.USR$TOTALDOCKEY = :TotalDocKey " & _
            "        GROUP BY 1, 2, 3, 4 " & _
            "        HAVING SUM(cha.USR$SUMMA) <> 0 " & _
            "        ORDER BY pt.USR$CODE " & _
            "        INTO :code, :FeeTypeName, :typeId, :Category, :S " & _
            "      DO " & _
            "        BEGIN " & _
            "          IF (accdedStr <> '') THEN accdedStr = accdedStr || ','; " & _
            "          accdedStr = accdedStr || '{""typeId"":""' || typeId || " & _
            "            '"",""db"":""' || DBJson || " & _
            "            '"",""de"":""' || DEJson || " & _
            "            '"",""s"":' || S || '}'; " & _
            "        END " & _
            " " & _
            "      /* вычеты*/ " & _
            "      FOR " & _
            "        SELECT dt.USR$CODE, " & _
            "          dt.USR$NAME        AS Name, " & _
            "          CAST(r.XID AS VARCHAR(14)) || '_' || CAST(r.DBID AS VARCHAR(14)) AS typeId, " & _
            "          'TAX_DEDUCTION'    AS Category, " & _
            "          SUM(cha.USR$SUMMA) AS Summa " & _
            "        FROM USR$WG_CHREGADDINFO cha " & _
            "          JOIN USR$WG_TAXINCOMDEDEDUCTTYPE dt ON dt.ID = cha.USR$INCTAXDEDTYPEKEY " & _
            "          LEFT JOIN GD_P_GETRUID(dt.ID) r ON 1 = 1 " & _
            "        WHERE cha.USR$EMPLKEY = :EmployeeKey " & _
            "          AND cha.USR$TOTALDOCKEY = :TotalDocKey " & _
            "          AND cha.USR$SUMMA <> 0 " & _
            "        GROUP BY 1, 2, 3, 4 " & _
            "        HAVING SUM(cha.USR$SUMMA) <> 0 " & _
            "        ORDER BY dt.USR$CODE " & _
            "        INTO  :code, :FeeTypeName, :typeId, :Category, :S " & _
            "      DO " & _
            "        BEGIN " & _
            "          IF (accdedStr <> '') THEN accdedStr = accdedStr || ','; " & _
            "          accdedStr = accdedStr || '{""typeId"":""' || typeId || " & _
            "            '"",""db"":""' || DBJson || " & _
            "            '"",""de"":""' || DEJson || " & _
            "            '"",""s"":' || S || '}'; " & _
            "        END " & _
            " " & _
            "      /*Сальдо на конец*/ " & _
            "      FeeTypeName = 'Сальдо на конец'; " & _
            "      typeId = 'saldo'; " & _
            "      Category = 'SALDO'; " & _
            "      S = EndSaldo; " & _
            "      IF (accdedStr <> '') THEN accdedStr = accdedStr || ','; " & _
            "          accdedStr = accdedStr || '{""typeId"":""' || typeId || " & _
            "            '"",""db"":""' || DBJson || " & _
            "            '"",""de"":""' || DEJson || " & _
            "            '"",""s"":' || S || '}'; " & _
            " " & _
            "      IF (accdedStr <> '') THEN SUSPEND; " & _
            " " & _
            "    END " & _
            "END; "
        
          qSel.ParamByName("DB").AsDateTime = Period(0)
          qSel.ParamByName("DE").AsDateTime = Period(1)
          qSel.ParamByName("pDate").AsDateTime = pDate
          qSel.ParamByName("companyId").AsInteger = companyId
          qSel.ExecQuery
        
          dim qSelDep
          set qSelDep = Creator.GetObject(nil, "TIBSQL", "")
          qSelDep.Transaction = Transaction
          qSelDep.SQL.Text = _
            "EXECUTE BLOCK (EmplKey dintkey = :EmplKey, CompanyId dintkey = :CompanyId) " & _
            "  RETURNS( " & _
            "    JSON_POS VARCHAR(4000), " & _
            "    JSON_SALARY VARCHAR(4000), " & _
            "    JSON_HOURRATE VARCHAR(4000), " & _
            "    JSON_DEPT VARCHAR(4000), " & _
            "    JSON_PAYFORM VARCHAR(4000)) " & _
            "AS " & _
            "  DECLARE VARIABLE PosID VARCHAR(50); " & _
            "  DECLARE VARIABLE DeptID VARCHAR(50); " & _
            "  DECLARE VARIABLE PrevPosID VARCHAR(50) = ''; " & _
            "  DECLARE VARIABLE PrevDeptID VARCHAR(50) = ''; " & _
            "  DECLARE VARIABLE PosName VARCHAR(1024); " & _
            "  DECLARE VARIABLE DeptName VARCHAR(1024); " & _
            "  DECLARE VARIABLE Salary NUMERIC(15, 4); " & _
            "  DECLARE VARIABLE PrevSalary NUMERIC(15, 4); " & _
            "  DECLARE VARIABLE HourRate NUMERIC(15, 4); " & _
            "  DECLARE VARIABLE PrevHourRate NUMERIC(15, 4); " & _
            "  DECLARE VARIABLE D DATE; " & _
            "  DECLARE VARIABLE DJson VARCHAR(20); " & _
            "  DECLARE VARIABLE PayFormKey dforeignkey; " & _
            "  DECLARE VARIABLE PrevFormKey dforeignkey; " & _
            "BEGIN " & _
            "  JSON_POS = ''; " & _
            "  JSON_DEPT = ''; " & _
            "  JSON_SALARY = ''; " & _
            "  JSON_HOURRATE = ''; " & _
            "  JSON_PAYFORM = ''; " & _
            "  PrevSalary = -1; " & _
            "  PrevHourRate = -1; " & _
            "  PrevFormKey = -1; " & _
            " " & _
            "  FOR " & _
            "    SELECT " & _
            "      CAST(rPos.XID AS VARCHAR(14)) || '_' || CAST(rPos.DBID AS VARCHAR(14)), " & _
            "      Trim(Replace(Replace(Replace(Replace(Replace(pos.NAME, '\', '\\'), '""', '\""'), '" & vbCrLf & "', '\n'), '" & vbTab & "', '\t'), '" & vbCr & "', '\n')), " & _
            "      CAST(rDept.XID AS VARCHAR(14)) || '_' || CAST(rDept.DBID AS VARCHAR(14)), " & _
            "      Trim(Replace(Replace(Replace(Replace(Replace(dept.NAME, '\', '\\'), '""', '\""'), '" & vbCrLf & "', '\n'), '" & vbTab & "', '\t'), '" & vbCr & "', '\n')), " & _
            "      ml.USR$MSALARY, " & _
            "      ml.USR$MHOURRATE, " & _
            "      ml.USR$DATEBEGIN, " & _
            "      COALESCE(ml.USR$PAYFORMKEY, 0) " & _
            "    FROM " & _
            "      USR$WG_MOVEMENTLINE ml " & _
            "      LEFT JOIN WG_POSITION pos ON pos.ID = ml.USR$POSITIONKEY " & _
            "      LEFT JOIN GD_CONTACT dept ON dept.ID = ml.USR$DEPTKEY " & _
            "      LEFT JOIN GD_P_GETRUID(pos.ID) rPos ON 1 = 1 " & _
            "      LEFT JOIN GD_P_GETRUID(dept.ID) rDept ON 1 = 1 " & _
            "      LEFT JOIN GD_DOCUMENT doc ON doc.ID = ml.DOCUMENTKEY " & _
            "    WHERE ml.USR$EMPLKEY = :EmplKey " & _
            "      AND ml.USR$MOVEMENTTYPE NOT IN (3, 7) " & _
            "      AND doc.COMPANYKEY = :CompanyId " & _
            "      AND ml.USR$KINDOFWORKKEY <> <RUID XID =147017406 DBID = 119619099/> /*не внутреннее совмещение*/ " & _
            "    ORDER BY " & _
            "      ml.USR$DATEBEGIN " & _
            "    INTO " & _
            "      :PosID, :PosName, :DeptID, :DeptName, :Salary, :HourRate, :D, :PayFormKey " & _
            "  DO BEGIN " & _
            "    /* может быть ситуация, когда будет документ изменения, но должность      */ " & _
            "    /* останется прежней. такие записи нас не интересуют с т.зр. формирования */ " & _
            "    /* расчетного листка                                                      */ " & _
            "    DJson = EXTRACT(YEAR FROM :D) || '.' || RIGHT('0' || EXTRACT(MONTH FROM :D), 2) || '.' || RIGHT('0' || EXTRACT(DAY FROM :D), 2); " & _
            "    IF (:PosID <> :PrevPosID) THEN " & _
            "    BEGIN " & _
            " " & _
            "      IF (:JSON_POS > '') THEN " & _
            "      BEGIN " & _
            "        JSON_POS = :JSON_POS || ','; " & _
            "      END " & _
            " " & _
            "      JSON_POS = :JSON_POS || '{""id"":""' || :PosID " & _
            "        || '"",""name"":{""ru"":{""name"":""' || :PosName " & _
            "        || '""}},""d"":""' || :DJson || '""}'; " & _
            "    END " & _
            " " & _
            "    IF (:DeptID <> :PrevDeptID) THEN " & _
            "    BEGIN " & _
            " " & _
            "      IF (:JSON_DEPT > '') THEN " & _
            "      BEGIN " & _
            "        JSON_DEPT = :JSON_DEPT || ','; " & _
            "      END " & _
            " " & _
            "      JSON_DEPT = :JSON_DEPT || '{""id"":""' || :DeptID " & _
            "        || '"",""name"":{""ru"":{""name"":""' || :DeptName " & _
            "        || '""}},""d"":""' || :DJson || '""}'; " & _
            "    END " & _
            " " & _
            "    IF (:Salary <> :PrevSalary) THEN " & _
            "    BEGIN " & _
            " " & _
            "      IF (:JSON_SALARY > '') THEN " & _
            "      BEGIN " & _
            "        JSON_SALARY = :JSON_SALARY || ','; " & _
            "      END " & _
            " " & _
            "      JSON_SALARY = :JSON_SALARY || '{""s"":' || salary " & _
            "        || ',""d"":""' || :DJson || '""}'; " & _
            "    END " & _
            " " & _
            "    IF (:HourRate <> :PrevHourRate) THEN " & _
            "    BEGIN " & _
            " " & _
            "      IF (:JSON_HOURRATE > '') THEN " & _
            "      BEGIN " & _
            "        JSON_HOURRATE = :JSON_HOURRATE || ','; " & _
            "      END " & _
            " " & _
            "      JSON_HOURRATE = :JSON_HOURRATE || '{""s"":' || HourRate " & _
            "        || ',""d"":""' || :DJson || '""}'; " & _
            "    END " & _
            "     " & _
            "    IF (:PayFormKey <> :PrevFormKey) THEN " & _
            "    BEGIN " & _
            " " & _
            "      IF (:JSON_PAYFORM > '') THEN " & _
            "      BEGIN " & _
            "        JSON_PAYFORM = :JSON_PAYFORM || ','; " & _
            "      END " & _
            " " & _
            "      JSON_PAYFORM = :JSON_PAYFORM || '{""slr"":' || IIF(:PayFormKey = <RUID XID =147009181 DBID = 119619099/> /*форма оплаты - оклад*/, 'true', 'false') " & _
            "        || ',""d"":""' || :DJson || '""}'; " & _
            "    END " & _
            " " & _
            "    PrevPosID = :PosID; " & _
            "    PrevDeptID = :DeptID; " & _
            "    PrevSalary = :Salary; " & _
            "    PrevHourRate = :HourRate; " & _
            "    PrevFormKey = :PayFormKey; " & _
            "  END " & _
            " " & _
            "  JSON_POS = '[' || JSON_POS || ']'; " & _
            "  JSON_DEPT = '[' || JSON_DEPT || ']'; " & _
            "  JSON_SALARY = '[' || JSON_SALARY || ']'; " & _
            "  JSON_HOURRATE = '[' || JSON_HOURRATE || ']'; " & _
            "  JSON_PAYFORM = '[' || JSON_PAYFORM || ']'; " & _
            "  SUSPEND; " & _
            "END "
        
        
          dim employeeItems, objItem, JsonDept, JsonPos, JsonSalary, EmployeeRuid, JsonPayForm
          dim emplkey_prev, hiringdate_prev, nickname_prev
        
          EmployeeRuid = ""
          dim canceled, strData, JsonHourRate
          canceled = false
          while not qSel.eof and not canceled
            if qSel.FieldByName("EmployeeRuid").AsString <> EmployeeRuid and EmployeeRuid <> "" then
              if isManual then
                canceled = P.Canceled
                P.StartStep "Сотрудник: " & nickname_prev, 1
              end if
              'добавляем запись по сотруднику
              qSelDep.Close
              qSelDep.ParamByName("EmplKey").AsInteger = emplkey_prev
              qSelDep.ParamByName("CompanyId").AsInteger = companyId
              qSelDep.ExecQuery
              JsonDept = qSelDep.FieldByName("JSON_DEPT").AsString
              JsonPos = qSelDep.FieldByName("JSON_POS").AsString
              JsonSalary = qSelDep.FieldByName("JSON_SALARY").AsString
              JsonPayForm = qSelDep.FieldByName("JSON_PAYFORM").AsString
              if qSelDep.FieldByName("JSON_HOURRATE").AsString <> "" then
                JsonHourRate = """hourrate"":" & qSelDep.FieldByName("JSON_HOURRATE").AsString & ","
              end if
        
              objItem = "{""emplId"":""" & EmployeeRuid & """," & _
                """dept"":" & JsonDept & "," & _
                """pos"":" & JsonPos & "," & _
                """salary"":" & JsonSalary & "," & _
                """payForm"":" & JsonPayForm & "," & _
                JsonHourRate & _
                """data"": [" & employeeItems & "]"  & _
                "}"
        
              Jsons.Add("{""version"":""1.0""," & _
                """customerId"":""" & customerId & """," & _
                """rewrite"":" & b & "," & _
                """objData"":" & objItem & "}")
              employeeItems = ""
            end if
        
            if employeeItems <> "" then employeeItems = employeeItems & ","
            employeeItems = employeeItems & qSel.FieldByName("accdedStr").AsString
            EmployeeRuid = qSel.FieldByName("EmployeeRuid").AsString
            emplkey_prev = qSel.FieldByName("EmployeeKey").AsInteger
            nickname_prev = qSel.FieldByName("NickName").AsString
            qSel.Next
          wend
        
          if EmployeeRuid <> "" then
            if isManual then P.StartStep "Сотрудник: " & qSel.FieldByName("NickName").AsString, 1
            'добавляем запись по сотруднику
            qSelDep.Close
            qSelDep.ParamByName("EmplKey").AsInteger = qSel.FieldByName("EmployeeKey").AsInteger
            qSelDep.ParamByName("CompanyId").AsInteger = companyId
            qSelDep.ExecQuery
            JsonDept = qSelDep.FieldByName("JSON_DEPT").AsString
            JsonPos = qSelDep.FieldByName("JSON_POS").AsString
            JsonPayForm = qSelDep.FieldByName("JSON_PAYFORM").AsString
            JsonSalary = qSelDep.FieldByName("JSON_SALARY").AsString
            if qSelDep.FieldByName("JSON_HOURRATE").AsString <> "" then
              JsonHourRate = """hourrate"":" & qSelDep.FieldByName("JSON_HOURRATE").AsString & ","
            end if
        
            objItem = "{""emplId"":""" & qSel.FieldByName("EmployeeRuid").AsString & """," & _
              """dept"":" & JsonDept & "," & _
              """pos"":" & JsonPos & "," & _
              """salary"":" & JsonSalary & "," & _
              """payForm"":" & JsonPayForm & "," & _
              JsonHourRate & _
              """data"": [" & employeeItems & "]"  & _
              "}"
        
            Jsons.Add("{""version"":""1.0""," & _
              """customerId"":""" & customerId & """," & _
              """rewrite"":" & b & "," & _
              """objData"":" & objItem & "}")
          end if
        
          if Transaction.InTransaction then
            Transaction.Commit
          end if
        
          if isManual then P.EndWork "Данные по расчетным листкам отправлены на сервер!", False
        End Function
        
        sub bot_PreparePaySlip_RollBack(Transaction)
          if Transaction.InTransaction then
            Transaction.Rollback
          end if
        end sub
        
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 1193785027_1320926323
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "bot_PrepareAccDed"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2020-06-12T18:16:12+03:00
      DISPLAYSCRIPT: | 
        BOT_PREPAREACCDED
        BOT_PREPAREACCDED_ROLLBACK
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QKAAAAQ1VTVE9NRVJJRAoAAABDVVNUT01FUklEAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAEZOU1RQUlNUCAAAAElTTUFOVUFMCAAAAElTTUFOVUFMAAAAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAEZOU1RQUlNUBAAAAEpTT04EAAAASlNPTgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      SCRIPT: | 
        '#include BOT_STRREPL
        Option Explicit
        Function bot_prepareAccDed(customerId, isManual, ByRef Json)
          dim Creator, Transaction
          set Creator = new TCreator
          set Transaction = Creator.GetObject(nil, "TIBTransaction", "")
          Transaction.Defaultdatabase = IBLogin.Database
          if not Transaction.InTransaction then
            Transaction.StartTransaction
          end if
        
          except bot_prepareAccDed_RollBack(Transaction)
        
          if isManual then
            dim qSelCount
            set qSelCount = Creator.GetObject(nil, "TIBSQL", "")
            qSelCount.Transaction = gdcBaseManager.ReadTransaction
            qSelCount.SQL.Text = _
              "SELECT COUNT(DISTINCT sel.ID) AS C " & _
              "FROM " & _
              "(SELECT ft.ID " & _
              "FROM USR$WG_FEETYPE ft " & _
              "  LEFT JOIN USR$WG_P_GETFEETYPEBYGROUP(<RUID XID = 184134911 DBID = 1194748640/>) gr_adv ON gr_adv.FEETYPE = ft.ID " & _
              "  LEFT JOIN GD_P_GETRUID(ft.ID) r ON 1 = 1 " & _
              " " & _
              "UNION ALL " & _
              "SELECT pt.ID " & _
              "FROM  USR$WG_PRIVILEGETYPE pt " & _
              "LEFT JOIN GD_P_GETRUID(pt.ID) r ON 1 = 1 " & _
              " " & _
              "UNION ALL " & _
              "SELECT d.ID " & _
              "FROM USR$WG_TAXINCOMDEDEDUCTTYPE d " & _
              "LEFT JOIN GD_P_GETRUID(d.ID) r ON 1 = 1 " & _
              ") sel "
            qSelCount.ExecQuery
        
            dim count
            count = qSelCount.FieldByName("C").AsInteger
        
            dim P : set P = Creator.GetObject(nil, "TgdccProgress", "")
            P.StartWork "ZarobakBot", "Формируем данные..", count, True, True
          end if
        
          dim qSel
          set qSel = Creator.GetObject(nil, "TIBSQL", "")
          qSel.Transaction = Transaction
          qSel.SQL.Text = _
            "SELECT ft.USR$NUMERICCODE AS N, " & _
            "  CASE " & _
            "    WHEN ft.ID = <RUID XID = 147653395 DBID = 119619099/> THEN 'PENSION_TAX' " & _
            "    WHEN ft.ID = <RUID XID = 147567139 DBID = 119619099/> THEN 'INCOME_TAX' " & _
            "    WHEN ft.ID = <RUID XID = 147653396 DBID = 119619099/> THEN 'TRADE_UNION_TAX'  /*налог*/ " & _
            "    WHEN NOT gr_adv.FEETYPE IS NULL THEN 'ADVANCE'                        /*аванс*/ " & _
            "    WHEN COALESCE(ft.USR$DEDUCTION, 0) = 1 THEN 'DEDUCTION'               /*удержание*/ " & _
            "    ELSE 'ACCRUAL'                                                        /*начисление*/ " & _
            "  END  AS category, " & _
            "  REPLACE(ft.USR$NAME, '""', '\""')                                         AS name, " & _
            "  CAST(r.XID AS VARCHAR(12)) || '_' || CAST(r.DBID AS VARCHAR(12))  AS typeId " & _
            "FROM USR$WG_FEETYPE ft " & _
            "  LEFT JOIN USR$WG_P_GETFEETYPEBYGROUP(<RUID XID = 184134911 DBID = 1194748640/>) gr_adv ON gr_adv.FEETYPE = ft.ID " & _
            "  LEFT JOIN GD_P_GETRUID(ft.ID) r ON 1 = 1 " & _
            "   " & _
            "UNION ALL " & _
            "SELECT -1 AS N, " & _
            "  'PRIVILAGE'    AS category, " & _
            "  REPLACE(pt.USR$NAME, '""', '\""')    AS name, " & _
            "  CAST(r.XID AS VARCHAR(12)) || '_' || CAST(r.DBID AS VARCHAR(12)) AS typeId " & _
            "FROM  USR$WG_PRIVILEGETYPE pt " & _
            "LEFT JOIN GD_P_GETRUID(pt.ID) r ON 1 = 1 " & _
            " " & _
            "UNION ALL " & _
            "SELECT -1 AS N, " & _
            "  'TAX_DEDUCTION'    AS category, " & _
            "  REPLACE(d.USR$NAME, '""', '\""')    AS name, " & _
            "  CAST(r.XID AS VARCHAR(12)) || '_' || CAST(r.DBID AS VARCHAR(12)) AS typeId " & _
            "FROM USR$WG_TAXINCOMDEDEDUCTTYPE d " & _
            "LEFT JOIN GD_P_GETRUID(d.ID) r ON 1 = 1 " & _
            " " & _
            "ORDER BY 1, 2, 3 "
          qSel.ExecQuery
        
          dim canceled, strSortNumber
          canceled = false
          while not qSel.eof and not canceled
            if isManual then
              canceled = P.Canceled
              P.StartStep "Вид начисления: " & qSel.FieldByName("name").AsString, 1
            end if
            if Json.Count > 0 then Json.Strings(Json.Count - 1) = Json.Strings(Json.Count - 1) & ","
        
            if qSel.FieldByName("n").AsInteger > 0 then
              strSortNumber = """n"":""" & qSel.FieldByName("n").AsInteger & ""","
            else
              strSortNumber = ""
            end if
        
            Json.Add("""" & qSel.FieldByName("typeId").AsString & """:{" & _
              """type"":""" & bot_strRepl(qSel.FieldByName("category").AsString) & """," & _
              strSortNumber & _
              """name"":{""ru"":{""name"":""" & bot_strRepl(qSel.FieldByName("name").AsString) & """}}}")
            qSel.Next
          wend
        
          if Transaction.InTransaction then
            Transaction.Commit
          end if
        
          if Json.Count > 0 then Json.Strings(Json.Count - 1) = Json.Strings(Json.Count - 1) & ","
        
          if qSel.FieldByName("n").AsInteger > 0 then
            strSortNumber = """n"":""" & qSel.FieldByName("n").AsInteger & ""","
          else
            strSortNumber = ""
          end if
        
          Json.Add("""" & "saldo" & """:{" & _
            """type"":""" & "SALDO" & """," & _
            strSortNumber & _
            """name"":{""ru"":{""name"":""" & "Сальдо" & """}}}")
        
          Json.Text = "{" & _
            """version"":""1.0""," & _
            """customerId"":""" & customerId & """," & _
            """objData"":{" & Json.Text & "}" & _
            "}"
        
          if isManual then
            P.EndWork "Данные по видам начисления отправлены на сервер!", False
          end if
        End Function
        
        sub bot_prepareAccDed_RollBack(Transaction)
          if Transaction.InTransaction then
            Transaction.Rollback
          end if
        end sub
        
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147160790_1454092899 bot_strRepl"
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 1437183754_1434991069
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      NAME: "bot_PrepareEmployees"
      COMMENT: ~
      EVENT: ~
      FUNCTIONTYPE: ~
      GROUPNAME: ~
      INHERITEDRULE: 0
      LANGUAGE: "VBScript"
      LOCALNAME: ~
      MODIFYDATE: ~
      MODULE: "UNKNOWN"
      MODULECODE: "1010001_17 APPLICATION"
      OBJECTNAME: "APPLICATION"
      OWNERNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      USEDEBUGINFO: 0
      EDITIONDATE: 2020-06-23T13:51:13+03:00
      DISPLAYSCRIPT: | 
        BOT_PREPAREEMPLOYEES
        BOT_PREPAREEMPLOYEES_ROLLBACK
        
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QKAAAAQ1VTVE9NRVJJRAoAAABDVVNUT01FUklEAAAAAAAAAAAAAAAABQAAAAAAAAAA
        AAAAAEZOU1RQUlNUCQAAAENPTVBBTllJRAkAAABDT01QQU5ZSUQAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAAAARk5TVFBSU1QIAAAASVNNQU5VQUwIAAAASVNNQU5VQUwAAAAAAAAAAAAAAAAAAAAAAAAA
        AAAAAAAARk5TVFBSU1QEAAAASlNPTgQAAABKU09OAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      SCRIPT: | 
        '#include BOT_STRREPL
        Option Explicit
        Function bot_prepareEmployees(customerId, companyId, isManual, ByRef Json)
          dim Creator, Transaction
          set Creator = new TCreator
          set Transaction = Creator.GetObject(nil, "TIBTransaction", "")
          Transaction.Defaultdatabase = IBLogin.Database
          if not Transaction.InTransaction then
            Transaction.StartTransaction
          end if
        
          except bot_prepareEmployees_RollBack(Transaction)
        
          'pDate - дата окончания последнего итогового
          dim qSelDate, pDate
          set qSelDate = Creator.GetObject(nil, "TIBSQL", "")
          qSelDate.Transaction = gdcBaseManager.ReadTransaction
          qSelDate.SQL.Text = _
            "  SELECT FIRST 1 t.USR$DATEEND " & _
            "  FROM USR$WG_TOTAL t " & _
            "    JOIN USR$WG_TOTALLINE tline ON tline.MASTERKEY = t.DOCUMENTKEY " & _
            "    LEFT JOIN GD_DOCUMENT doc ON doc.ID = t.DOCUMENTKEY " & _
            "  WHERE doc.COMPANYKEY = :companyId " & _
            "  ORDER BY t.USR$DATEEND DESC "
          qSelDate.ParamByName("companyId").AsInteger = companyId
          qSelDate.ExecQuery
          pDate = qSelDate.FieldByName("USR$DATEEND").AsDateTime
        
          if isManual then
            dim qSelCount
            set qSelCount = Creator.GetObject(nil, "TIBSQL", "")
            qSelCount.Transaction = gdcBaseManager.ReadTransaction
            qSelCount.SQL.Text = _
              "SELECT COUNT(DISTINCT TRIM(card.USR$PERSONALNUMBER)) " & _
              "FROM GD_CONTACT own " & _
              "  LEFT JOIN GD_CONTACT c ON own.LB <= c.LB AND own.RB >= c.RB " & _
              "  JOIN USR$WG_TOTALLINE l ON l.USR$EMPLKEY = c.ID " & _
              "  JOIN GD_EMPLOYEE empl ON empl.CONTACTKEY = c.ID " & _
              "  JOIN GD_PEOPLE p ON p.CONTACTKEY = c.ID " & _
              "  JOIN USR$WG_EMPLWORKTERM w ON w.USR$EMPLKEY = c.ID " & _
              "  LEFT JOIN USR$WG_P_EMPLCARDSTATE(c.ID, :pDate) pcard ON 1 = 1 " & _
              "  LEFT JOIN USR$WG_PERSONALCARD card ON card.ID = pcard.ID " & _
              "WHERE own.ID = :companyId " & _
              "  AND COALESCE(TRIM(card.USR$PERSONALNUMBER), '') <> '' " & _
              "  AND (w.USR$DATEEND > :pDate OR w.USR$DATEEND IS NULL) "
            qSelCount.ParamByName("companyId").AsInteger = companyId
            qSelCount.ParamByName("pDate").AsDateTime = pDate
            qSelCount.ExecQuery
        
            dim count
            count = qSelCount.FieldByName("C").AsInteger
        
            dim P : set P = Creator.GetObject(nil, "TgdccProgress", "")
            P.StartWork "ZarobakBot", "Формируем данные..", count, True, True
          end if
        
          dim qSel
          set qSel = Creator.GetObject(nil, "TIBSQL", "")
          qSel.Transaction = Transaction
          qSel.SQL.Text = _
            "SELECT DISTINCT p.SURNAME, p.FIRSTNAME, p.MIDDLENAME, " & _
            "  TRIM(card.USR$PERSONALNUMBER)  AS PERSONALNUMBER, " & _
            "  CAST(r.XID AS VARCHAR(12)) || '_' || CAST(r.DBID AS VARCHAR(12))  AS ID, " & _
            "  EXTRACT(YEAR FROM p.BIRTHDAY) || '.' || RIGHT('0' || EXTRACT(MONTH FROM p.BIRTHDAY), 2) || '.' || RIGHT('0' || EXTRACT(DAY FROM p.BIRTHDAY), 2) AS BIRTHDAY, " & _
            "  c.EDITIONDATE " & _
            "FROM GD_CONTACT own " & _
            "  LEFT JOIN GD_CONTACT c ON own.LB <= c.LB AND own.RB >= c.RB " & _
            "  JOIN USR$WG_TOTALLINE l ON l.USR$EMPLKEY = c.ID " & _
            "  JOIN GD_PEOPLE p ON p.CONTACTKEY = c.ID " & _
            "  LEFT JOIN GD_P_GETRUID(p.CONTACTKEY) r ON 1 = 1 " & _
            "  JOIN USR$WG_EMPLWORKTERM w ON w.USR$EMPLKEY = c.ID " & _
            "  LEFT JOIN USR$WG_P_EMPLCARDSTATE(c.ID, :pDate) pcard ON 1 = 1 " & _
            "  LEFT JOIN USR$WG_PERSONALCARD card ON card.ID = pcard.ID " & _
            "WHERE own.ID = :companyId " & _
            "  AND COALESCE(TRIM(card.USR$PERSONALNUMBER), '') <> '' " & _
            "  AND (w.USR$DATEEND > :pDate OR w.USR$DATEEND IS NULL) " & _
            "ORDER BY TRIM(card.USR$PERSONALNUMBER), c.EDITIONDATE DESC, p.SURNAME "
        
          qSel.ParamByName("companyId").AsInteger = companyId
          qSel.ParamByName("pDate").AsDateTime = pDate
          qSel.ExecQuery
        
          dim canceled, persNumber
          canceled = false
          persNumber = ""
          while not qSel.eof and not canceled
            if persNumber <> qSel.FieldByName("PERSONALNUMBER").AsString then
              if isManual then
                canceled = P.Canceled
                P.StartStep "Сотрудник: " & qSel.FieldByName("SURNAME").AsString & " " & qSel.FieldByName("FIRSTNAME").AsString & " " & qSel.FieldByName("MIDDLENAME").AsString, 1
              end if
              if Json.Count > 0 then Json.Strings(Json.Count - 1) = Json.Strings(Json.Count - 1) & ","
              Json.Add("""" & qSel.FieldByName("ID").AsString & """:{" & _
                """firstName"":""" & bot_strRepl(qSel.FieldByName("FIRSTNAME").AsString) & """," & _
                """lastName"":""" & bot_strRepl(qSel.FieldByName("SURNAME").AsString) & """," & _
                """patrName"":""" & bot_strRepl(qSel.FieldByName("MIDDLENAME").AsString) & """," & _
                """birthday"":""" & qSel.FieldByName("BIRTHDAY").AsString & """," & _
                """passportId"":""" & bot_strRepl(qSel.FieldByName("PERSONALNUMBER").AsString) & """}")
            end if
            persNumber = qSel.FieldByName("PERSONALNUMBER").AsString
            qSel.Next
          wend
        
          if Transaction.InTransaction then
            Transaction.Commit
          end if
        
          Json.Text = "{" & _
            """version"":""1.0""," & _
            """customerId"":""" & customerId & """," & _
            """objData"":{" & Json.Text & "}" & _
            "}"
        
          if isManual then P.EndWork "Данные по сотрудникам отправлены на сервер!", False
        End Function
        
        sub bot_prepareEmployees_RollBack(Transaction)
          if Transaction.InTransaction then
            Transaction.Rollback
          end if
        end sub
        
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147160790_1454092899 bot_strRepl"